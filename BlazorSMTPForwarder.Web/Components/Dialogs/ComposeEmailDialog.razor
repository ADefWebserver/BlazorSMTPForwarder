@using Radzen
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using System.Net.Mail
@using System.Net
@using System.ComponentModel.DataAnnotations
@using Azure.Data.Tables
@using Azure
@using Azure.Data.Tables.Models
@using System.Text.Json
@using BlazorSMTPForwarder.ServiceDefaults.Models

<div class="rz-p-2">
    <RadzenNotification />

    @if (!string.IsNullOrWhiteSpace(_settingsError))
    {
        <div class="rz-text-danger rz-mb-2">@_settingsError</div>
    }

    <EditForm Model="@_model" OnValidSubmit="HandleValidSubmitAsync">
        <DataAnnotationsValidator />
        <div class="rz-grid rz-g-2">
            <div>
                <RadzenLabel Text="From" />
                <RadzenTextBox @bind-Value="_model.From" Style="width:100%" />
            </div>
            <div>
                <RadzenLabel Text="To" />
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <RadzenTextBox @bind-Value="ToUser" Change="@UpdateToAddress" Style="flex: 1;" Placeholder="User" />
                    <span>@("@")</span>
                    <RadzenDropDown Data="@Domains" TextProperty="DomainName" ValueProperty="DomainName" @bind-Value="ToDomain" Change="@UpdateToAddress" Style="flex: 1;" Placeholder="Select Domain" />
                </div>
                <ValidationMessage For="@(() => _model.To)" />
            </div>
            <div style="grid-column: 1 / -1;">
                <RadzenLabel Text="Subject" />
                <RadzenTextBox @bind-Value="_model.Subject" Style="width:100%" />
            </div>
            <div style="grid-column: 1 / -1;">
                <RadzenLabel Text="Body" />
                <RadzenTextArea @bind-Value="_model.Body" Rows="8" Style="width:100%" />
            </div>
            <div class="rz-d-flex rz-justify-content-end rz-g-2" style="grid-column: 1 / -1;">
                <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@Cancel" />
                <RadzenButton ButtonStyle="ButtonStyle.Primary" Disabled="@_sending" ButtonType="Radzen.ButtonType.Submit" Text="@(_sending ? "Sending..." : "Send")" />
            </div>
        </div>
    </EditForm>
</div>

@code {
    [Parameter] public string? DefaultTo { get; set; }
    [Parameter] public string? DefaultFrom { get; set; }
    [Parameter] public string? DefaultSubject { get; set; }
    [Parameter] public string? DefaultBody { get; set; }

    [Inject] public DialogService DialogService { get; set; } = default!;
    [Inject] public NotificationService NotificationService { get; set; } = default!;
    [Inject] public TableServiceClient TableServiceClient { get; set; } = default!;
    [Inject] public NavigationManager Nav { get; set; } = default!;

    private class ComposeModel
    {
        [EmailAddress]
        public string From { get; set; } = "sender@example.com";
        [Required(ErrorMessage = "Recipient (To) is required.")]
        [EmailAddress(ErrorMessage = "Invalid email address.")]
        public string To { get; set; } = string.Empty;
        [Required]
        public string Subject { get; set; } = "Test from Blazor";
        [Required]
        public string Body { get; set; } = "This is a test email from the Blazor app.";
    }

    private readonly ComposeModel _model = new();

    private bool _sending;
    private string? _settingsError;

    private List<DomainConfiguration> Domains = new();
    private string ToUser = "";
    private string ToDomain = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadDomainsAsync();
    }

    private async Task LoadDomainsAsync()
    {
        try
        {
            var table = TableServiceClient.GetTableClient("SMTPSettings");
            var settings = await table.GetEntityIfExistsAsync<TableEntity>("SmtpServer", "Current");
            if (settings.HasValue)
            {
                var domainsJson = settings.Value?.GetString("DomainsJson");
                if (!string.IsNullOrEmpty(domainsJson))
                {
                    try { Domains = JsonSerializer.Deserialize<List<DomainConfiguration>>(domainsJson) ?? new(); }
                    catch { Domains = new(); }
                }
            }
            
            if (string.IsNullOrEmpty(ToDomain) && Domains.Any())
            {
                ToDomain = Domains.First().DomainName;
                UpdateToAddress();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading domains: {ex.Message}");
        }
    }

    private void UpdateToAddress()
    {
        if (!string.IsNullOrWhiteSpace(ToUser) && !string.IsNullOrWhiteSpace(ToDomain))
        {
            _model.To = $"{ToUser}@{ToDomain}";
        }
        else
        {
            _model.To = string.Empty;
        }
    }

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrWhiteSpace(DefaultTo) && string.IsNullOrWhiteSpace(_model.To))
        {
            _model.To = DefaultTo!;
            var parts = _model.To.Split('@');
            if (parts.Length == 2)
            {
                ToUser = parts[0];
                ToDomain = parts[1];
            }
            else
            {
                ToUser = _model.To;
            }
        }
        if (!string.IsNullOrWhiteSpace(DefaultFrom))
        {
            _model.From = DefaultFrom!;
        }
        if (!string.IsNullOrWhiteSpace(DefaultSubject))
        {
            _model.Subject = DefaultSubject!;
        }
        if (DefaultBody is not null)
        {
            _model.Body = DefaultBody;
        }
    }

    private Task Cancel()
    {
        DialogService.Close(false);
        return Task.CompletedTask;
    }

    private async Task HandleValidSubmitAsync(EditContext _)
    {
        await SendAsync();
    }

    private void ShowError(string message)
    {
        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Error,
            Summary = "Error",
            Detail = message,
            Duration = 5000
        });
    }

    private string ResolveSmtpHost()
    {
        return "127.0.0.1";
    }

    private async Task<int> GetFirstPortAsync()
    {
        const string SettingsTableName = "SMTPSettings";
        const string PartitionKey = "SmtpServer";
        const string RowKey = "Current";
        try
        {
            var table = TableServiceClient.GetTableClient(SettingsTableName);
            var entityResponse = await table.GetEntityAsync<TableEntity>(PartitionKey, RowKey);
            var entity = entityResponse.Value;
            // Prefer PortsJson
            if (entity.TryGetValue("PortsJson", out var portsJsonObj) && portsJsonObj is string portsJson && !string.IsNullOrWhiteSpace(portsJson))
            {
                try
                {
                    var ports = JsonSerializer.Deserialize<int[]>(portsJson) ?? Array.Empty<int>();
                    var first = ports.FirstOrDefault();
                    if (first > 0) return first;
                }
                catch { /* ignore parse errors */ }
            }
            if (entity.TryGetValue("Ports", out var portsCsvObj) && portsCsvObj is string portsCsv && !string.IsNullOrWhiteSpace(portsCsv))
            {
                var firstStr = portsCsv.Split(',').Select(s => s.Trim()).FirstOrDefault();
                if (int.TryParse(firstStr, out var p) && p > 0) return p;
            }
        }
        catch (Exception ex)
        {
            _settingsError = $"Warning: Could not read SMTP port from table storage, falling back to 2525. {ex.Message}";
        }
        return 25; // fallback development port
    }

    private async Task SendAsync()
    {
        if (string.IsNullOrWhiteSpace(_model.To))
        {
            _settingsError = "Recipient (To) is required.";
            ShowError(_settingsError);
            return;
        }

        try
        {
            _sending = true;

            // Resolve host, port and credentials from Table Storage similar to SmtpTest
            var smtpHost = ResolveSmtpHost();
            var port = await GetFirstPortAsync();

            using var client = new SmtpClient(smtpHost, port)
            {
                EnableSsl = false,
                Timeout = 50000
            };

            var message = new MailMessage
            {
                From = new MailAddress(string.IsNullOrWhiteSpace(_model.From) ? "sender@example.com" : _model.From),
                Subject = _model.Subject,
                Body = _model.Body
            };
            message.To.Add(_model.To);

            await client.SendMailAsync(message);
            DialogService.Close(true);
        }
        catch (Exception ex)
        {
            _settingsError = $"Failed to send: {ex.Message}";
            ShowError(_settingsError);
        }
        finally
        {
            _sending = false;
        }
    }
}
